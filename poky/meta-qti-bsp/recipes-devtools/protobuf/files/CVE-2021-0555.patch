From b866b6d10ac195e863e30c5bccfe3b4426435ca4 Mon Feb 08 14:49:18 2021 -0800
From: Colin Cross <ccross@android.com>
Date: Wed Feb 10 18:05:42 2021 +0000
Subject: [PATCH] Backport null pointer check from upstream

Backport null pointer check from upstream

Backport [1] from upstream to avoid a null pointer dereference.

[1] https://github.com/protocolbuffers/protobuf/commit/32e5deb1ac76feb4f187371c2a7f76c9009b1eff#diff-9ac2dd60c731243464677560177e2552aaf5fb4301333d475ed039343f36d63f

Bug: 179161711
Test: mmma external/protobuf
---
src/google/protobuf/util/internal/protostream_objectsource.cc | 5 +++++
1 file changed, 5 insertions(+)

diff --git a/src/google/protobuf/util/internal/protostream_objectsource.cc b/src/google/protobuf/util/internal/protostream_objectsource.cc
index 252184d..f632064 100644
--- a/src/google/protobuf/util/internal/protostream_objectsource.cc
+++ b/src/google/protobuf/util/internal/protostream_objectsource.cc
@@ -539,6 +539,11 @@
   ow->StartObject(field_name);
   while (tag != 0) {
     field = os->FindAndVerifyField(type, tag);
+    if (field == nullptr) {
+      WireFormat::SkipField(os->stream_, tag, nullptr);
+      tag = os->stream_->ReadTag();
+      continue;
+    }
     // google.protobuf.Struct has only one field that is a map. Hence we use
     // RenderMap to render that field.
     if (os->IsMap(*field)) {
